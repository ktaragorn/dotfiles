#{{ansible_managed}}
# parts taken from https://www.rosehosting.com/blog/install-php-7-1-with-nginx-on-an-ubuntu-16-04-vps/
server {
	listen 80 default_server;
	listen [::]:80 default_server;
	root /var/www/html;
	server_name _;
    index index.htm index.html index.php;

	{% for service in proxied_services %}
	location /{{service.name}}/ {
		proxy_set_header Host      $host:$server_port;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;
		proxy_set_header X-Deluge-Base "/deluge/";
		proxy_pass {{service.scheme | default("http")}}://{{service.host | default("localhost")}}:{{service.port}}{{service.terminate | default("")}};
		proxy_redirect http://{{service.host | default("localhost")}}:{{service.port}}/ $host:$server_port/{{service.name}}/;
		# https needed for webmin, / in the end needed for deluge, /in the end not needed for htpc
	}
	{% endfor %}

	location / {
	# First attempt to serve request as file, then
	# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}

	location ~ \.php$ {
	    fastcgi_pass unix:/run/php/php7.0-fpm.sock;
	    include snippets/fastcgi-php.conf;
	    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
	}

	location ~ /\.ht {
	        deny all;
	}
}